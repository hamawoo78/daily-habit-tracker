{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mood History - Do Your Best</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="{% static 'history.css' %}">


</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Your Mood Journey üìä</h1>
            <p>Hello {{ username }}! Here's your emotional wellness tracking</p>
        </div>
        
        {% if entries %}
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-emoji">üòä</div>
                <div class="stat-value" id="avgMood">-</div>
                <div class="stat-label">Average Mood</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-emoji">üìÖ</div>
                <div class="stat-value">{{ entries|length }}</div>
                <div class="stat-label">Days Tracked</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-emoji">üò¥</div>
                <div class="stat-value" id="avgSleep">-</div>
                <div class="stat-label">Avg Sleep (hrs)</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-emoji">üßò</div>
                <div class="stat-value" id="yogaCount">-</div>
                <div class="stat-label">Yoga Days</div>
            </div>
        </div>
        
        <div class="chart-section">
            <div class="chart-title">Mood Trend Over Time</div>
            <canvas id="moodChart" height="80"></canvas>
        </div>
        
        <div class="calendar-section">
            <div class="calendar-header">
                <h2 id="calendarMonth">MOOD TRACKER</h2>
                <div class="month-nav">
                    <button onclick="navigateMonth('prev')">‚Üê Previous</button>
                    <button class="current-month-btn" onclick="openMonthPicker()">
                        <span id="currentMonthYear"></span>
                    </button>
                    <button onclick="navigateMonth('next')">Next ‚Üí</button>
                </div>
            </div>
            
            <div class="calendar-grid">
                <div class="calendar-day-header">Sun</div>
                <div class="calendar-day-header">Mon</div>
                <div class="calendar-day-header">Tue</div>
                <div class="calendar-day-header">Wed</div>
                <div class="calendar-day-header">Thu</div>
                <div class="calendar-day-header">Fri</div>
                <div class="calendar-day-header">Sat</div>
                
                <div id="calendarDays"></div>
            </div>
            
            <div class="mood-legend">
                <div class="legend-item">
                    <span class="legend-emoji">üò¢</span>
                    <span class="legend-label">Terrible</span>
                </div>
                <div class="legend-item">
                    <span class="legend-emoji">üòï</span>
                    <span class="legend-label">Not Great</span>
                </div>
                <div class="legend-item">
                    <span class="legend-emoji">üòê</span>
                    <span class="legend-label">Okay</span>
                </div>
                <div class="legend-item">
                    <span class="legend-emoji">üòä</span>
                    <span class="legend-label">Good</span>
                </div>
                <div class="legend-item">
                    <span class="legend-emoji">üòÑ</span>
                    <span class="legend-label">Amazing</span>
                </div>
            </div>
        </div>
        
        {% else %}
        <div class="empty-state">
            <p>No mood entries yet!</p>
            <p>Start tracking your mood to see your progress here.</p>
        </div>
        {% endif %}
        
        <div class="bottom-nav">
            <a href="{% url 'habits_tracker' %}" class="back-btn">‚Üê Back to Tracker</a>
        </div>
    </div>
    
    <!-- Month Picker Modal -->
    <div id="monthPickerModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">Select Month & Year</h3>
            <div class="modal-form">
                <select id="monthSelect" class="modal-select">
                    <option value="1">January</option>
                    <option value="2">February</option>
                    <option value="3">March</option>
                    <option value="4">April</option>
                    <option value="5">May</option>
                    <option value="6">June</option>
                    <option value="7">July</option>
                    <option value="8">August</option>
                    <option value="9">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                </select>
                <select id="yearSelect" class="modal-select">
                    <!-- Years will be populated by JavaScript -->
                </select>
                <div class="modal-buttons">
                    <button class="modal-btn secondary" onclick="closeMonthPicker()">Cancel</button>
                    <button class="modal-btn primary" onclick="applyMonthPicker()">Apply</button>
                </div>
            </div>
        </div>
    </div>
    
    {{ django_data_json|json_script:"django-data" }}
    <script>
        // Get Django data from JSON script
        const djangoData = JSON.parse(document.getElementById('django-data').textContent);
        
        // Get current year and month from Django
        let currentYear = djangoData.currentYear;
        let currentMonth = djangoData.currentMonth;
        
        // Mood emoji mapping
        const moodEmojis = {
            1: 'üò¢',
            2: 'üòï',
            3: 'üòê',
            4: 'üòä',
            5: 'üòÑ'
        };
        
        const sleepLabels = {
            1: '4h-',
            2: '5h',
            3: '6h',
            4: '7h',
            5: '8h',
            6: '9h+'
        };
        
        // Get entries data from Django data
        const allEntries = djangoData.allEntries || [];
        const monthEntries = djangoData.monthEntries || [];
        
        // Calculate statistics (using Django data)
        if (djangoData.hasEntries) {
            document.getElementById('avgMood').textContent = djangoData.avgMood;
            document.getElementById('avgSleep').textContent = sleepLabels[Math.round(djangoData.avgSleep)];
            document.getElementById('yogaCount').textContent = djangoData.yogaCount;
        }
        
        // Update current month display
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                          'July', 'August', 'September', 'October', 'November', 'December'];
        document.getElementById('currentMonthYear').textContent = `${monthNames[currentMonth - 1]} ${currentYear}`;
        
        // Month navigation
        function navigateMonth(direction) {
            if (direction === 'prev') {
                window.location.href = `?year=${djangoData.prevYear}&month=${djangoData.prevMonth}`;
            } else {
                window.location.href = `?year=${djangoData.nextYear}&month=${djangoData.nextMonth}`;
            }
        }
        
        // Month picker modal
        function openMonthPicker() {
            const modal = document.getElementById('monthPickerModal');
            const yearSelect = document.getElementById('yearSelect');
            const monthSelect = document.getElementById('monthSelect');
            
            // Populate years (current year ¬± 5 years)
            yearSelect.innerHTML = '';
            const currentYearNow = new Date().getFullYear();
            for (let y = currentYearNow - 5; y <= currentYearNow + 5; y++) {
                const option = document.createElement('option');
                option.value = y;
                option.textContent = y;
                if (y === currentYear) option.selected = true;
                yearSelect.appendChild(option);
            }
            
            // Set current month
            monthSelect.value = currentMonth;
            
            modal.classList.add('show');
        }
        
        function closeMonthPicker() {
            document.getElementById('monthPickerModal').classList.remove('show');
        }
        
        function applyMonthPicker() {
            const month = document.getElementById('monthSelect').value;
            const year = document.getElementById('yearSelect').value;
            window.location.href = `?year=${year}&month=${month}`;
        }
        
        // Close modal on outside click
        document.getElementById('monthPickerModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeMonthPicker();
            }
        });
        
        // Create mood chart
        if (allEntries.length > 0) {
            const ctx = document.getElementById('moodChart').getContext('2d');
            
            // Sort entries by date
            const sortedEntries = [...allEntries].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Take last 30 entries for chart
            const chartEntries = sortedEntries.slice(-30);
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartEntries.map(e => {
                        const date = new Date(e.date);
                        return `${date.getMonth() + 1}/${date.getDate()}`;
                    }),
                    datasets: [{
                        label: 'Mood',
                        data: chartEntries.map(e => e.mood),
                        borderColor: '#FF5F5F',
                        backgroundColor: 'rgba(255, 95, 95, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointBackgroundColor: '#FF3838',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 0,
                            max: 6,
                            ticks: {
                                stepSize: 1,
                                callback: function(value) {
                                    return moodEmojis[value] || '';
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }
        
        // Render calendar for current month
        function renderCalendar() {
            // Get first day of month and number of days
            const firstDay = new Date(currentYear, currentMonth - 1, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
            
            // Create calendar
            const calendarDays = document.getElementById('calendarDays');
            calendarDays.innerHTML = '';
            
            // Add empty cells for days before month starts
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day';
                calendarDays.appendChild(emptyDay);
            }
            
            // Add days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const entry = monthEntries.find(e => e.date === dateStr);
                
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';
                
                if (entry) {
                    dayDiv.classList.add('has-entry');
                    dayDiv.innerHTML = `
                        <div class="day-number">${day}</div>
                        <div class="day-mood">${moodEmojis[entry.mood]}</div>
                        <div class="day-icons">
                            <span class="day-icon">${sleepLabels[entry.sleep]}</span>
                            ${entry.yoga ? '<span class="day-icon">üßò</span>' : ''}
                        </div>
                    `;
                    
                    if (entry.note) {
                        dayDiv.title = entry.note;
                    }
                } else {
                    dayDiv.innerHTML = `<div class="day-number" style="color: #ccc;">${day}</div>`;
                }
                
                calendarDays.appendChild(dayDiv);
            }
        }
        
        // Initial render
        renderCalendar();
    </script>
</body>
</html>