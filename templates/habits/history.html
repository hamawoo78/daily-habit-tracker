{% extends 'base.html' %}
{% load static %}

{% block title %}Mood History - Do Your Best{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'history.css' %}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{% endblock %}

{% block content %}
<div class="header">
    <h1>Your Mood Journey üìä</h1>
    <p>Hello {{ username }}! Here's your emotional wellness tracking</p>
</div>

{% if entries %}
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-emoji">üòä</div>
        <div class="stat-value">{{ stats.avg_mood|floatformat:1 }}</div>
        <div class="stat-label">Average Mood</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-emoji">üìÖ</div>
        <div class="stat-value">{{ entries|length }}</div>
        <div class="stat-label">Days Tracked</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-emoji">üò¥</div>
        <div class="stat-value">{{ stats.avg_sleep|floatformat:1 }}h</div>
        <div class="stat-label">Avg Sleep</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-emoji">üßò</div>
        <div class="stat-value">{{ stats.yoga_count }}</div>
        <div class="stat-label">Yoga Days</div>
    </div>
</div>

<div class="chart-section">
    <div class="chart-title">
        <span class="chart-icon">üìä</span>
        Wellness Tracking Overview
    </div>
    <div class="chart-wrapper">
        <canvas id="combinedChart"></canvas>
    </div>
</div>

<div class="bottom-nav">
    <a href="{% url 'habits_tracker' %}" class="back-btn">‚Üê Back to Tracker</a>
</div>

{% else %}
<div class="empty-state">
    <div class="empty-state-icon">üìä</div>
    <p>No mood entries yet!</p>
    <p>Start tracking your mood to see your progress here.</p>
    <div class="bottom-nav">
        <a href="{% url 'habits_tracker' %}" class="back-btn">‚Üê Start Tracking</a>
    </div>
</div>
{% endif %}

<!-- Chart data as JSON -->
<script id="chart-data" type="application/json">
    [
        {% for entry in entries|slice:":30" %}
        {
            "date": "{{ entry.date|date:'M j' }}",
            "mood": {{ entry.mood }},
            "sleep": {{ entry.sleep_duration|default:0 }},
            "yoga": {{ entry.yoga|yesno:"1,0" }}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ]
</script>
{% endblock %}

{% block extra_js %}
<script>
    // Mood emoji mapping
    const moodEmojis = {
        1: 'üòû',
        2: 'üòê',
        3: 'üôÇ',
        4: 'üòÑ',
        5: 'ü§©'
    };
    
    // Get chart data from JSON script tag
    const chartDataElement = document.getElementById('chart-data');
    const chartData = chartDataElement ? JSON.parse(chartDataElement.textContent) : [];
    
    // Sleep duration labels
    const sleepLabels = {
        1: '4h-',
        2: '5h',
        3: '6h',
        4: '7h',
        5: '8h',
        6: '9h+'
    };
    
    // Sleep hour values for better visualization
    const sleepHours = {
        1: 3.5,
        2: 5,
        3: 6,
        4: 7,
        5: 8,
        6: 9.5
    };
    
    // Create charts if we have data
    if (chartData.length > 0) {
        // Sort by date and take last 30 entries
        const sortedData = chartData.reverse().slice(-30);
        
        // Common chart options
        const commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: {
                        size: 14,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 13
                    },
                    borderColor: 'rgba(255, 255, 255, 0.1)',
                    borderWidth: 1
                }
            }
        };
        
        // Combined Chart - All metrics in one chart
        const combinedCtx = document.getElementById('combinedChart').getContext('2d');
        
        new Chart(combinedCtx, {
            type: 'line',
            data: {
                labels: sortedData.map(d => d.date),
                datasets: [
                    {
                        label: 'Mood',
                        data: sortedData.map(d => d.mood),
                        borderColor: '#FF5F5F',
                        backgroundColor: 'rgba(255, 95, 95, 0.1)',
                        fill: false,
                        tension: 0.4,
                        pointRadius: 6,
                        pointBackgroundColor: '#FF3838',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Sleep Duration (hours)',
                        data: sortedData.map(d => sleepHours[d.sleep]),
                        borderColor: '#36A2EB',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        fill: false,
                        tension: 0.4,
                        pointRadius: 5,
                        pointBackgroundColor: '#36A2EB',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        yAxisID: 'y1'
                    },
                    {
                        label: 'Yoga Practice',
                        data: sortedData.map(d => parseInt(d.yoga) * 5), // Scale to 5 for visibility
                        borderColor: '#9966FF',
                        backgroundColor: 'rgba(153, 102, 255, 0.1)',
                        fill: false,
                        tension: 0,
                        pointRadius: 8,
                        pointStyle: sortedData.map(d => parseInt(d.yoga) ? 'circle' : 'crossRot'),
                        pointBackgroundColor: sortedData.map(d => 
                            parseInt(d.yoga) ? '#9966FF' : 'rgba(153, 102, 255, 0.3)'
                        ),
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        yAxisID: 'y'
                    }
                ]
            },
            options: {
                ...commonOptions,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: {
                                size: 12
                            }
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        min: 0,
                        max: 6,
                        ticks: {
                            stepSize: 1,
                            padding: 10,
                            font: {
                                size: 12
                            },
                            callback: function(value) {
                                if (value === 5) return 'üßò Yoga';
                                return moodEmojis[value] || '';
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)',
                            drawBorder: false
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        min: 0,
                        max: 10,
                        ticks: {
                            stepSize: 1,
                            padding: 10,
                            font: {
                                size: 12
                            },
                            callback: function(value) {
                                return value + 'h';
                            }
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                    }
                },
                plugins: {
                    ...commonOptions.plugins,
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        ...commonOptions.plugins.tooltip,
                        callbacks: {
                            label: function(context) {
                                const datasetLabel = context.dataset.label;
                                const value = context.parsed.y;
                                
                                if (datasetLabel === 'Mood') {
                                    const moodLabels = {
                                        1: 'Terrible',
                                        2: 'Not Great', 
                                        3: 'Okay',
                                        4: 'Good',
                                        5: 'Amazing'
                                    };
                                    return `${moodEmojis[value]} ${moodLabels[value]}`;
                                } else if (datasetLabel === 'Sleep Duration (hours)') {
                                    return `üò¥ ${value}h sleep`;
                                } else if (datasetLabel === 'Yoga Practice') {
                                    return value === 5 ? 'üßò Practiced yoga' : '‚ùå No yoga today';
                                }
                                return `${datasetLabel}: ${value}`;
                            }
                        }
                    }
                }
            }
        });
    }
</script>
{% endblock %}